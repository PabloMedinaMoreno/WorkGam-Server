<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/task.controller.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/task.controller.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {
  acceptTaskService,
  deleteTaskService,
  updateTaskService,
  getCompletedTasksService,
  getPendingTaskService,
  getTasksService,
  rejectTaskService,
  uploadTaskService,
  getClientStartedTasksService,
  getClientPendingTasksService,
} from '../services/task.service.js';

/**
 * Retrieves all tasks.
 *
 * Responds with:
 *  - 200 OK: If tasks are retrieved successfully.
 *  - 500 Internal Server Error: If an error occurs while retrieving tasks.
 *
 * @param {Object} req - The HTTP request object.
 * @param {Object} res - The HTTP response object.
 */
export const getTasks = async (req, res) => {
  try {
    const tasks = await getTasksService();
    res.status(200).json(tasks);
  } catch (error) {
    console.error('Error al obtener las tareas:', error);
    res.status(500).json({ message: 'Error al obtener las tareas' });
  }
};

/**
 * Retrieves pending tasks for the authenticated employee.
 *
 * Responds with:
 *  - 200 OK: If pending tasks are retrieved successfully.
 *  - 500 Internal Server Error: If an error occurs while retrieving pending tasks.
 *
 * @param {Object} req - The HTTP request object. Expects req.user.id.
 * @param {Object} res - The HTTP response object.
 */
export const getPendingTasks = async (req, res) => {
  const employeeId = req.user.id;
  try {
    const tasks = await getPendingTaskService(employeeId);
    res.status(200).json(tasks);
  } catch (error) {
    console.error('Error al obtener las tareas pendientes:', error);
    res.status(500).json({ message: 'Error al obtener las tareas pendientes' });
  }
};

/**
 * Retrieves completed tasks for the authenticated employee.
 *
 * Responds with:
 *  - 200 OK: If completed tasks are retrieved successfully.
 *  - 500 Internal Server Error: If an error occurs while retrieving completed tasks.
 *
 * @param {Object} req - The HTTP request object. Expects req.user.id.
 * @param {Object} res - The HTTP response object.
 */
export const getCompletedTasks = async (req, res) => {
  const employeeId = req.user.id;
  try {
    const completedTasks = await getCompletedTasksService(employeeId);
    res.status(200).json(completedTasks);
  } catch (error) {
    console.error('Error al obtener las tareas completadas:', error);
    res
      .status(500)
      .json({ message: 'Error al obtener las tareas completadas' });
  }
};

/**
 * Accepts a task.
 *
 * Responds with:
 *  - 200 OK: If the task is accepted successfully.
 *  - 500 Internal Server Error: If an error occurs while accepting the task.
 *
 * @param {Object} req - The HTTP request object. Expects req.params.startedTaskId and req.body.socketId.
 * @param {Object} res - The HTTP response object.
 */
export const acceptTask = async (req, res) => {
  const { startedTaskId } = req.params;
  const employeeId = req.user.id;
  const { socketId } = req.body;
  try {
    const updatedTask = await acceptTaskService(
      startedTaskId,
      employeeId,
      socketId,
      req.app.locals.io,
    );
    res.status(200).json(updatedTask);
  } catch (error) {
    console.error('Error al aceptar la tarea:', error);
    res.status(500).json({ message: 'Error al aceptar la tarea' });
  }
};

/**
 * Rejects a task.
 *
 * Responds with:
 *  - 200 OK: If the task is rejected successfully.
 *  - 500 Internal Server Error: If an error occurs while rejecting the task.
 *
 * @param {Object} req - The HTTP request object. Expects req.params.startedTaskId, req.body.reason, and req.body.socketId.
 * @param {Object} res - The HTTP response object.
 */
export const rejectTask = async (req, res) => {
  const { startedTaskId } = req.params;
  const employeeId = req.user.id;
  const { reason, socketId } = req.body;
  try {
    const updatedTask = await rejectTaskService(
      startedTaskId,
      employeeId,
      reason,
      socketId,
      req.app.locals.io,
    );
    res.status(200).json(updatedTask);
  } catch (error) {
    console.error('Error al rechazar la tarea:', error);
    res.status(500).json({ message: 'Error al rechazar la tarea' });
  }
};

/**
 * Deletes a task.
 *
 * Responds with:
 *  - 204 No Content: If the task is deleted successfully.
 *  - 500 Internal Server Error: If an error occurs while deleting the task.
 *
 * @param {Object} req - The HTTP request object. Expects req.params.taskId.
 * @param {Object} res - The HTTP response object.
 */
export const deleteTask = async (req, res) => {
  const { taskId } = req.params;
  try {
    await deleteTaskService(taskId);
    res.status(204).send();
  } catch (error) {
    if (error.message === 'Tarea no encontrada') {
      return res.status(404).json({ message: error.message });
    }
    console.error('Error al eliminar la tarea:', error);
    res.status(500).json({ message: 'Error al eliminar la tarea' });
  }
};

/**
 * Uploads a document for a task.
 *
 * Responds with:
 *  - 200 OK: If the document is uploaded and the task is started successfully.
 *  - 500 Internal Server Error: If an error occurs while uploading the task document.
 *
 * @param {Object} req - The HTTP request object. Expects req.params.startedProcedureId, req.params.taskId, req.user.id, and req.file.
 * @param {Object} res - The HTTP response object.
 */
export const uploadTask = async (req, res) => {
  const { startedProcedureId, taskId } = req.params;
  const clientId = req.user.id;
  try {
    const startedTask = await uploadTaskService(
      clientId,
      startedProcedureId,
      taskId,
      req.file,
    );
    res
      .status(200)
      .json({ message: 'Tarea iniciada correctamente', task: startedTask });
  } catch (error) {
    console.log('Al subir la tarea', error.message);
    if (error.message === 'La tarea ya est치 completada o pendiente') {
      console.error('La tarea ya est치 completada o pendiente:', error);
      res.status(409).json({ message: error.message });
    }
    else { // Handle other errors
      console.error('Error al subir el documento de la tarea:', error);
      res.status(500).json({ message: 'Error al subir el documento de la tarea' });
    }
  }
};

/**
 * Updates a task's details.
 *
 * Responds with:
 *  - 200 OK: If the task is updated successfully.
 *  - 500 Internal Server Error: If an error occurs while updating the task.
 *
 * @param {Object} req - The HTTP request object. Expects req.params.taskId and task details in req.body.
 * @param {Object} res - The HTTP response object.
 */
export const updateTask = async (req, res) => {
  const { taskId } = req.params;
  const {
    name,
    description,
    xp,
    procedure_id,
    role_id,
    estimated_duration_days,
    difficulty,
  } = req.body;
  try {
    const updatedTask = await updateTaskService(taskId, {
      name,
      description,
      xp,
      procedure_id,
      role_id,
      estimated_duration_days,
      difficulty,
    });
    res.status(200).json(updatedTask);
  } catch (error) {
    if (error.message === 'Tarea no encontrada') {
      return res.status(404).json({ message: error.message });
    }
    res.status(500).json({ message: 'Error al actualizar la tarea' });
  }
};

// Controlador para obtener las tareas y su estado
export const getClientStartedTasks = async (req, res) => {
  const { startedProcedureId } = req.params;
  const clientId = req.user.id;


  try {
    // Obtener las tareas iniciadas para el procedimiento iniciado y cliente
    const result = await getClientStartedTasksService(startedProcedureId, clientId);

    // Responder con dos arrays: tareas completadas o con documentos, y tareas sin documentos o rechazadas
    res.status(200).json(result);
  } catch (error) {
    console.error('Error al obtener el estado de las tareas del tr치mite:', error);
    res.status(500).json({ message: error.message || 'Error al obtener el estado de las tareas' });
  }
};

export const getClientPendingTasks = async (req, res) => {
  const { startedProcedureId } = req.params;
  const clientId = req.user.id;

  try {
    // Obtener las tareas iniciadas para el procedimiento iniciado y cliente
    const result = await getClientPendingTasksService(startedProcedureId, clientId);

    // Responder con dos arrays: tareas completadas o con documentos, y tareas sin documentos o rechazadas
    res.status(200).json(result);
  } catch (error) {
    console.error('Error al obtener el estado de las tareas del tr치mite:', error);
    res.status(500).json({ message: error.message || 'Error al obtener el estado de las tareas' });
  }
};

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#acceptTask">acceptTask</a></li><li><a href="global.html#acceptTaskService">acceptTaskService</a></li><li><a href="global.html#authRequired">authRequired</a></li><li><a href="global.html#calculateXPGamification">calculateXPGamification</a></li><li><a href="global.html#cancelStartedProcedure">cancelStartedProcedure</a></li><li><a href="global.html#cancelStartedProcedureService">cancelStartedProcedureService</a></li><li><a href="global.html#changePassword">changePassword</a></li><li><a href="global.html#changePasswordService">changePasswordService</a></li><li><a href="global.html#checkBucketAccess">checkBucketAccess</a></li><li><a href="global.html#checkDBConnection">checkDBConnection</a></li><li><a href="global.html#checkS3Connection">checkS3Connection</a></li><li><a href="global.html#createAccessToken">createAccessToken</a></li><li><a href="global.html#createAndSendNotificationService">createAndSendNotificationService</a></li><li><a href="global.html#createProcedure">createProcedure</a></li><li><a href="global.html#createProcedureService">createProcedureService</a></li><li><a href="global.html#createProcedureTask">createProcedureTask</a></li><li><a href="global.html#createProcedureTaskService">createProcedureTaskService</a></li><li><a href="global.html#createRole">createRole</a></li><li><a href="global.html#createRoleService">createRoleService</a></li><li><a href="global.html#createWorker">createWorker</a></li><li><a href="global.html#createWorkerService">createWorkerService</a></li><li><a href="global.html#deleteAllNotifications">deleteAllNotifications</a></li><li><a href="global.html#deleteAllNotificationsService">deleteAllNotificationsService</a></li><li><a href="global.html#deleteNotification">deleteNotification</a></li><li><a href="global.html#deleteNotificationService">deleteNotificationService</a></li><li><a href="global.html#deleteProcedure">deleteProcedure</a></li><li><a href="global.html#deleteProcedureService">deleteProcedureService</a></li><li><a href="global.html#deleteRole">deleteRole</a></li><li><a href="global.html#deleteRoleService">deleteRoleService</a></li><li><a href="global.html#deleteTask">deleteTask</a></li><li><a href="global.html#deleteTaskService">deleteTaskService</a></li><li><a href="global.html#deleteWorker">deleteWorker</a></li><li><a href="global.html#deleteWorkerService">deleteWorkerService</a></li><li><a href="global.html#forgotPassword">forgotPassword</a></li><li><a href="global.html#forgotPasswordService">forgotPasswordService</a></li><li><a href="global.html#getClientPendingTasksService">getClientPendingTasksService</a></li><li><a href="global.html#getClientStartedTasksService">getClientStartedTasksService</a></li><li><a href="global.html#getCompletedTasks">getCompletedTasks</a></li><li><a href="global.html#getCompletedTasksService">getCompletedTasksService</a></li><li><a href="global.html#getEmployeeRolesService">getEmployeeRolesService</a></li><li><a href="global.html#getEmployeeStatistics">getEmployeeStatistics</a></li><li><a href="global.html#getEmployeeStatisticsService">getEmployeeStatisticsService</a></li><li><a href="global.html#getGamificationLevels">getGamificationLevels</a></li><li><a href="global.html#getGamificationLevelsService">getGamificationLevelsService</a></li><li><a href="global.html#getLevelProgression">getLevelProgression</a></li><li><a href="global.html#getLevelProgressionService">getLevelProgressionService</a></li><li><a href="global.html#getMyStartedProcedures">getMyStartedProcedures</a></li><li><a href="global.html#getMyStartedProceduresService">getMyStartedProceduresService</a></li><li><a href="global.html#getNotifications">getNotifications</a></li><li><a href="global.html#getNotificationsService">getNotificationsService</a></li><li><a href="global.html#getPendingTaskService">getPendingTaskService</a></li><li><a href="global.html#getPendingTasks">getPendingTasks</a></li><li><a href="global.html#getProcedureTasks">getProcedureTasks</a></li><li><a href="global.html#getProcedureTasksService">getProcedureTasksService</a></li><li><a href="global.html#getProcedures">getProcedures</a></li><li><a href="global.html#getProceduresService">getProceduresService</a></li><li><a href="global.html#getRanking">getRanking</a></li><li><a href="global.html#getRankingService">getRankingService</a></li><li><a href="global.html#getRoles">getRoles</a></li><li><a href="global.html#getRolesService">getRolesService</a></li><li><a href="global.html#getStartedProcedureTasks">getStartedProcedureTasks</a></li><li><a href="global.html#getStartedProcedureTasksService">getStartedProcedureTasksService</a></li><li><a href="global.html#getStartedProcedures">getStartedProcedures</a></li><li><a href="global.html#getStartedProceduresService">getStartedProceduresService</a></li><li><a href="global.html#getStartedTaskByStatusService">getStartedTaskByStatusService</a></li><li><a href="global.html#getStartedTaskService">getStartedTaskService</a></li><li><a href="global.html#getTaskService">getTaskService</a></li><li><a href="global.html#getTasks">getTasks</a></li><li><a href="global.html#getTasksService">getTasksService</a></li><li><a href="global.html#getUserLevelService">getUserLevelService</a></li><li><a href="global.html#getWorkers">getWorkers</a></li><li><a href="global.html#getWorkersService">getWorkersService</a></li><li><a href="global.html#handleXPAndNotificationService">handleXPAndNotificationService</a></li><li><a href="global.html#initializeDatabase">initializeDatabase</a></li><li><a href="global.html#insertDatabaseData">insertDatabaseData</a></li><li><a href="global.html#loadTemplate">loadTemplate</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#loginService">loginService</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#markAllNotificationsAsRead">markAllNotificationsAsRead</a></li><li><a href="global.html#markAllNotificationsAsReadService">markAllNotificationsAsReadService</a></li><li><a href="global.html#markNotificationAsRead">markNotificationAsRead</a></li><li><a href="global.html#markNotificationAsReadService">markNotificationAsReadService</a></li><li><a href="global.html#profile">profile</a></li><li><a href="global.html#profileService">profileService</a></li><li><a href="global.html#rejectTask">rejectTask</a></li><li><a href="global.html#rejectTaskService">rejectTaskService</a></li><li><a href="global.html#resetPassword">resetPassword</a></li><li><a href="global.html#resetPasswordService">resetPasswordService</a></li><li><a href="global.html#selectEmployeeByRoleService">selectEmployeeByRoleService</a></li><li><a href="global.html#sendEmail">sendEmail</a></li><li><a href="global.html#sendLevelUpNotificationService">sendLevelUpNotificationService</a></li><li><a href="global.html#sendWebSocketNotificationService">sendWebSocketNotificationService</a></li><li><a href="global.html#setupDatabaseSchema">setupDatabaseSchema</a></li><li><a href="global.html#signup">signup</a></li><li><a href="global.html#signupService">signupService</a></li><li><a href="global.html#startProcedure">startProcedure</a></li><li><a href="global.html#startProcedureService">startProcedureService</a></li><li><a href="global.html#updateEmployeeXPService">updateEmployeeXPService</a></li><li><a href="global.html#updateProcedure">updateProcedure</a></li><li><a href="global.html#updateProcedureService">updateProcedureService</a></li><li><a href="global.html#updateProfile">updateProfile</a></li><li><a href="global.html#updateProfilePic">updateProfilePic</a></li><li><a href="global.html#updateProfilePicService">updateProfilePicService</a></li><li><a href="global.html#updateProfileService">updateProfileService</a></li><li><a href="global.html#updateRole">updateRole</a></li><li><a href="global.html#updateRoleService">updateRoleService</a></li><li><a href="global.html#updateStartedProcedureStatusService">updateStartedProcedureStatusService</a></li><li><a href="global.html#updateStartedTaskStatusService">updateStartedTaskStatusService</a></li><li><a href="global.html#updateTask">updateTask</a></li><li><a href="global.html#updateTaskService">updateTaskService</a></li><li><a href="global.html#updateWorker">updateWorker</a></li><li><a href="global.html#updateWorkerService">updateWorkerService</a></li><li><a href="global.html#uploadTask">uploadTask</a></li><li><a href="global.html#uploadTaskService">uploadTaskService</a></li><li><a href="global.html#validateSchema">validateSchema</a></li><li><a href="global.html#verifyRole">verifyRole</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Sun May 04 2025 21:04:32 GMT+0100 (hora de verano de Europa occidental)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
