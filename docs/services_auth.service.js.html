<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/auth.service.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/auth.service.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import bcrypt from 'bcryptjs';
import jwt from 'jsonwebtoken';
import { pool } from '../databases/db.js';
import { JWT_SECRET, FRONTEND_URL } from '../constants/constants.js';
import { sendEmail } from '../utils/sendEmail.utils.js';
import { loadTemplate } from '../utils/templateLoader.utils.js';
import { createAccessToken } from '../utils/jwt.utils.js';

/**
 * Registers a new user.
 *
 * @param {Object} data - The user data.
 * @param {string} data.username - The username.
 * @param {string} data.email - The email address.
 * @param {string} data.password - The password.
 * @param {string} data.gender - The gender ("male" or "female").
 * @param {string} [data.phone] - The phone number (optional).
 * @returns {Promise&lt;Object>} An object containing the token and user data.
 * @throws {Error} Throws an error if the email already exists or if an error occurs during the process.
 */
export const signupService = async ({
  username,
  email,
  password,
  gender,
  phone,
}) => {
  try {
    // Check if the email already exists
    const emailCheck = await pool.query(
      'SELECT * FROM person WHERE email = $1',
      [email],
    );
    if (emailCheck.rowCount > 0) {
      throw new Error('El email ya está registrado');
    }

    // Hash the password
    const hashedPassword = await bcrypt.hash(password, 10);

    // Generate the profile picture based on gender
    const profilePic =
      gender === 'male'
        ? `https://avatar.iran.liara.run/public/boy?username=${username}`
        : `https://avatar.iran.liara.run/public/girl?username=${username}`;

    // Insert the user into the person table
    const person = await pool.query(
      'INSERT INTO person (username, email, password, profile_pic, phone) VALUES ($1, $2, $3, $4, $5) RETURNING *',
      [username, email, hashedPassword, profilePic, phone || null],
    );

    // Insert the user into the client table
    const personId = person.rows[0].id;
    await pool.query('INSERT INTO client (id) VALUES ($1)', [personId]);

    // Enviar email de bienvenida
    const htmlContent = loadTemplate('welcomeEmail.html', {
      USERNAME: username,
    });
    await sendEmail(email, 'Bienvenido a WorkGam', htmlContent);

    // Create the token
    const token = await createAccessToken({ id: personId, role: 'Cliente' });
    const userData = {
      id: personId,
      username,
      email,
      profile_pic: profilePic,
      phone,
      role: 'Cliente',
    };

    return { token, user: userData };
  } catch (error) {
    throw new Error(error.message);
  }
};

/**
 * Authenticates a user.
 *
 * @param {Object} data - The authentication data.
 * @param {string} data.email - The email address.
 * @param {string} data.password - The password.
 * @returns {Promise&lt;Object>} An object containing the token and user data.
 * @throws {Error} Throws an error if the user does not exist or if the password is incorrect.
 */
export const loginService = async ({ email, password }) => {
  try {
    const userQuery = await pool.query(
      `SELECT p.id, p.username, p.email, p.password, p.profile_pic, p.phone, 
              COALESCE(e.role_id, NULL) AS role_id, 
              COALESCE(r.name, 'Cliente') AS role
       FROM person p
       LEFT JOIN employee e ON p.id = e.id
       LEFT JOIN role r ON e.role_id = r.id
       WHERE p.email = $1`,
      [email],
    );

    if (userQuery.rowCount === 0) {
      throw new Error('El usuario no existe');
    }

    const user = userQuery.rows[0];

    // Compare the password
    const validPassword = await bcrypt.compare(password, user.password);
    if (!validPassword) {
      throw new Error('Contraseña inválida');
    }

    // Create the token
    const token = await createAccessToken({
      id: user.id,
      role:
        user.role === 'Administrador'
          ? 'Administrador'
          : user.role === 'Cliente'
            ? 'Cliente'
            : 'Empleado',
    });
    const userData = {
      id: user.id,
      username: user.username,
      email: user.email,
      role: user.role,
      profile_pic: user.profile_pic,
      phone: user.phone,
    };

    return {
      user: userData,
      token,
    };
  } catch (error) {
    throw new Error(error.message);
  }
};


/**
 * Retrieves the profile of a user.
 *
 * @param {number|string} personId - The ID of the user.
 * @returns {Promise&lt;Object>} The user's profile data.
 * @throws {Error} Throws an error if an error occurs while retrieving the profile.
 */
export const profileService = async (personId) => {
  try {
    const userQuery = await pool.query(
      `SELECT p.id, p.username, p.email, p.profile_pic, p.phone,
              COALESCE(e.role_id, NULL) AS role_id,
              COALESCE(r.name, 'Cliente') AS role
       FROM person p
       LEFT JOIN employee e ON p.id = e.id
       LEFT JOIN role r ON e.role_id = r.id
       WHERE p.id = $1`,
      [personId],
    );
    return userQuery.rows[0];
  } catch (error) {
    throw new Error(error.message || 'Error al obtener el perfil');
  }
};

/**
 * Updates the profile of a user.
 *
 * @param {number|string} personId - The ID of the user.
 * @param {Object} data - The profile data to update.
 * @param {string} data.username - The new username.
 * @param {string} data.email - The new email address.
 * @param {string} [data.phone] - The new phone number.
 * @returns {Promise&lt;Object>} The updated profile data.
 * @throws {Error} Throws an error if an error occurs while updating the profile.
 */
export const updateProfileService = async (
  personId,
  { username, email, phone },
) => {
  try {

    // Check if the email already exists for another user
    const emailCheck = await pool.query(
      'SELECT * FROM person WHERE email = $1 AND id != $2',
      [email, personId],
    );
    if (emailCheck.rowCount > 0) {
      throw new Error('El email ya está registrado');
    }

    await pool.query(
      'UPDATE person SET username = $1, email = $2, phone = $3 WHERE id = $4 RETURNING *',
      [username, email, phone || null, personId],
    );
    const user = await profileService(personId);
    return user;
  } catch (error) {
    throw new Error(error.message || 'Error al actualizar el perfil');
  }
};

/**
 * Updates the profile picture of a user.
 *
 * @param {number|string} personId - The ID of the user.
 * @param {Object} file - The file object containing the new profile picture.
 * @returns {Promise&lt;Object>} An object containing the new profile picture URL.
 * @throws {Error} Throws an error if an error occurs while updating the profile picture.
 */
export const updateProfilePicService = async (personId, file) => {
  try {
    const profilePic = file.location;
    await pool.query(
      'UPDATE person SET profile_pic = $1 WHERE id = $2 RETURNING *',
      [profilePic, personId],
    );
    const user = await profileService(personId);
    return user;
  } catch (error) {
    throw new Error(error.message || 'Error al actualizar la foto de perfil');
  }
};

/**
 * Changes the user's password.
 *
 * @param {number|string} personId - The ID of the user.
 * @param {Object} passwords - The password data.
 * @param {string} passwords.oldPassword - The current password.
 * @param {string} passwords.newPassword - The new password.
 * @param {string} passwords.confirmPassword - The confirmation of the new password.
 * @returns {Promise&lt;Object>} An object with a success message.
 * @throws {Error} Throws an error if the passwords do not match, the user is not found, or the current password is incorrect.
 */
export const changePasswordService = async (
  personId,
  { oldPassword, newPassword, confirmPassword },
) => {
  try {
    // Check that the new passwords match
    if (newPassword !== confirmPassword) {
      console.log('Las contraseñas no coinciden');
      throw new Error('Las contraseñas no coinciden');
    }

    // Retrieve the user from the database
    const userQuery = await pool.query(
      'SELECT password FROM person WHERE id = $1',
      [personId],
    );
    if (userQuery.rowCount === 0) {
      throw new Error('Usuario no encontrado');
    }

    const user = userQuery.rows[0];

    // Compare the current password
    const validPassword = await bcrypt.compare(oldPassword, user.password);
    if (!validPassword) {
      throw new Error('Contraseña actual incorrecta');
    }

    // Hash the new password
    const hashedPassword = await bcrypt.hash(newPassword, 10);

    // Update the password in the database
    await pool.query('UPDATE person SET password = $1 WHERE id = $2', [
      hashedPassword,
      personId,
    ]);

    return { message: 'Contraseña cambiada exitosamente' };
  } catch (error) {
    throw new Error(error.message);
  }
};

/**
 * Service to send the password recovery email.
 *
 * Looks up the user by email, generates a reset token with a 1-hour expiration,
 * loads a professional HTML email template located at src/templates/resetPasswordEmail.html,
 * and sends the email.
 *
 * @param {Object} param0 - An object containing the email.
 * @param {string} param0.email - The user's email address.
 * @returns {Promise&lt;Object>} A Promise that resolves with a success message.
 * @throws {Error} If the user does not exist.
 */
export async function forgotPasswordService({ email }) {
  // Look up the user in the person table
  const userQuery = await pool.query(
    'SELECT id, email FROM person WHERE email = $1',
    [email],
  );

  if (userQuery.rowCount === 0) {
    throw new Error('El email no está registrado');
  }

  const user = userQuery.rows[0];

  // Generate a reset token with a 1-hour expiration
  const token = await createAccessToken({ id: user.id }, '1h');

  // Build the reset link using the FRONTEND_URL from configuration
  const resetLink = `${FRONTEND_URL}/reset-password/${token}`;

  // Load the email template and replace the placeholder {{RESET_LINK}}
  const htmlContent = loadTemplate('resetPasswordEmail.html', {
    RESET_LINK: resetLink,
  });

  // Send the email with the template
  await sendEmail(user.email, 'Restablecer contraseña', htmlContent);

  return { message: 'El enlace para restablecer tu contraseña ha sido enviado', token };
}

/**
 * Service to reset the password.
 *
 * Verifies the provided token and, if valid, hashes the new password and updates it in the database.
 *
 * @param {Object} param0 - An object containing the reset token and new password.
 * @param {string} param0.token - The JWT token received via email.
 * @param {string} param0.password - The new password.
 * @returns {Promise&lt;Object>} A Promise that resolves with a success message.
 * @throws {Error} If the token is invalid or expired.
 */
export async function resetPasswordService({ token, password }) {
  let payload;
  try {
    // Verify the token; if invalid or expired, an error will be thrown
    payload = jwt.verify(token, JWT_SECRET);
  } catch (error) {
    console.error('Error al verificar el token:', error);
    throw new Error('Token inválido o expirado');
  }

  // Hash the new password
  const hashedPassword = await bcrypt.hash(password, 10);

  // Update the password in the person table using the id from the token payload
  await pool.query('UPDATE person SET password = $1 WHERE id = $2', [
    hashedPassword,
    payload.id,
  ]);

  return { message: 'La contraseña ha sido actualizada exitosamente' };
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#acceptTask">acceptTask</a></li><li><a href="global.html#acceptTaskService">acceptTaskService</a></li><li><a href="global.html#authRequired">authRequired</a></li><li><a href="global.html#calculateXPGamification">calculateXPGamification</a></li><li><a href="global.html#cancelStartedProcedure">cancelStartedProcedure</a></li><li><a href="global.html#cancelStartedProcedureService">cancelStartedProcedureService</a></li><li><a href="global.html#changePassword">changePassword</a></li><li><a href="global.html#changePasswordService">changePasswordService</a></li><li><a href="global.html#checkBucketAccess">checkBucketAccess</a></li><li><a href="global.html#checkDBConnection">checkDBConnection</a></li><li><a href="global.html#checkS3Connection">checkS3Connection</a></li><li><a href="global.html#createAccessToken">createAccessToken</a></li><li><a href="global.html#createAndSendNotificationService">createAndSendNotificationService</a></li><li><a href="global.html#createProcedure">createProcedure</a></li><li><a href="global.html#createProcedureService">createProcedureService</a></li><li><a href="global.html#createProcedureTask">createProcedureTask</a></li><li><a href="global.html#createProcedureTaskService">createProcedureTaskService</a></li><li><a href="global.html#createRole">createRole</a></li><li><a href="global.html#createRoleService">createRoleService</a></li><li><a href="global.html#createWorker">createWorker</a></li><li><a href="global.html#createWorkerService">createWorkerService</a></li><li><a href="global.html#deleteAllNotifications">deleteAllNotifications</a></li><li><a href="global.html#deleteAllNotificationsService">deleteAllNotificationsService</a></li><li><a href="global.html#deleteNotification">deleteNotification</a></li><li><a href="global.html#deleteNotificationService">deleteNotificationService</a></li><li><a href="global.html#deleteProcedure">deleteProcedure</a></li><li><a href="global.html#deleteProcedureService">deleteProcedureService</a></li><li><a href="global.html#deleteRole">deleteRole</a></li><li><a href="global.html#deleteRoleService">deleteRoleService</a></li><li><a href="global.html#deleteTask">deleteTask</a></li><li><a href="global.html#deleteTaskService">deleteTaskService</a></li><li><a href="global.html#deleteWorker">deleteWorker</a></li><li><a href="global.html#deleteWorkerService">deleteWorkerService</a></li><li><a href="global.html#forgotPassword">forgotPassword</a></li><li><a href="global.html#forgotPasswordService">forgotPasswordService</a></li><li><a href="global.html#getClientPendingTasksService">getClientPendingTasksService</a></li><li><a href="global.html#getClientStartedTasksService">getClientStartedTasksService</a></li><li><a href="global.html#getCompletedTasks">getCompletedTasks</a></li><li><a href="global.html#getCompletedTasksService">getCompletedTasksService</a></li><li><a href="global.html#getEmployeeRolesService">getEmployeeRolesService</a></li><li><a href="global.html#getEmployeeStatistics">getEmployeeStatistics</a></li><li><a href="global.html#getEmployeeStatisticsService">getEmployeeStatisticsService</a></li><li><a href="global.html#getGamificationLevels">getGamificationLevels</a></li><li><a href="global.html#getGamificationLevelsService">getGamificationLevelsService</a></li><li><a href="global.html#getLevelProgression">getLevelProgression</a></li><li><a href="global.html#getLevelProgressionService">getLevelProgressionService</a></li><li><a href="global.html#getMyStartedProcedures">getMyStartedProcedures</a></li><li><a href="global.html#getMyStartedProceduresService">getMyStartedProceduresService</a></li><li><a href="global.html#getNotifications">getNotifications</a></li><li><a href="global.html#getNotificationsService">getNotificationsService</a></li><li><a href="global.html#getPendingTaskService">getPendingTaskService</a></li><li><a href="global.html#getPendingTasks">getPendingTasks</a></li><li><a href="global.html#getProcedureTasks">getProcedureTasks</a></li><li><a href="global.html#getProcedureTasksService">getProcedureTasksService</a></li><li><a href="global.html#getProcedures">getProcedures</a></li><li><a href="global.html#getProceduresService">getProceduresService</a></li><li><a href="global.html#getRanking">getRanking</a></li><li><a href="global.html#getRankingService">getRankingService</a></li><li><a href="global.html#getRoles">getRoles</a></li><li><a href="global.html#getRolesService">getRolesService</a></li><li><a href="global.html#getStartedProcedureTasks">getStartedProcedureTasks</a></li><li><a href="global.html#getStartedProcedureTasksService">getStartedProcedureTasksService</a></li><li><a href="global.html#getStartedProcedures">getStartedProcedures</a></li><li><a href="global.html#getStartedProceduresService">getStartedProceduresService</a></li><li><a href="global.html#getStartedTaskByStatusService">getStartedTaskByStatusService</a></li><li><a href="global.html#getStartedTaskService">getStartedTaskService</a></li><li><a href="global.html#getTaskService">getTaskService</a></li><li><a href="global.html#getTasks">getTasks</a></li><li><a href="global.html#getTasksService">getTasksService</a></li><li><a href="global.html#getUserLevelService">getUserLevelService</a></li><li><a href="global.html#getWorkers">getWorkers</a></li><li><a href="global.html#getWorkersService">getWorkersService</a></li><li><a href="global.html#handleXPAndNotificationService">handleXPAndNotificationService</a></li><li><a href="global.html#initializeDatabase">initializeDatabase</a></li><li><a href="global.html#insertDatabaseData">insertDatabaseData</a></li><li><a href="global.html#loadTemplate">loadTemplate</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#loginService">loginService</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#markAllNotificationsAsRead">markAllNotificationsAsRead</a></li><li><a href="global.html#markAllNotificationsAsReadService">markAllNotificationsAsReadService</a></li><li><a href="global.html#markNotificationAsRead">markNotificationAsRead</a></li><li><a href="global.html#markNotificationAsReadService">markNotificationAsReadService</a></li><li><a href="global.html#profile">profile</a></li><li><a href="global.html#profileService">profileService</a></li><li><a href="global.html#rejectTask">rejectTask</a></li><li><a href="global.html#rejectTaskService">rejectTaskService</a></li><li><a href="global.html#resetPassword">resetPassword</a></li><li><a href="global.html#resetPasswordService">resetPasswordService</a></li><li><a href="global.html#selectEmployeeByRoleService">selectEmployeeByRoleService</a></li><li><a href="global.html#sendEmail">sendEmail</a></li><li><a href="global.html#sendLevelUpNotificationService">sendLevelUpNotificationService</a></li><li><a href="global.html#sendWebSocketNotificationService">sendWebSocketNotificationService</a></li><li><a href="global.html#setupDatabaseSchema">setupDatabaseSchema</a></li><li><a href="global.html#signup">signup</a></li><li><a href="global.html#signupService">signupService</a></li><li><a href="global.html#startProcedure">startProcedure</a></li><li><a href="global.html#startProcedureService">startProcedureService</a></li><li><a href="global.html#updateEmployeeXPService">updateEmployeeXPService</a></li><li><a href="global.html#updateProcedure">updateProcedure</a></li><li><a href="global.html#updateProcedureService">updateProcedureService</a></li><li><a href="global.html#updateProfile">updateProfile</a></li><li><a href="global.html#updateProfilePic">updateProfilePic</a></li><li><a href="global.html#updateProfilePicService">updateProfilePicService</a></li><li><a href="global.html#updateProfileService">updateProfileService</a></li><li><a href="global.html#updateRole">updateRole</a></li><li><a href="global.html#updateRoleService">updateRoleService</a></li><li><a href="global.html#updateStartedProcedureStatusService">updateStartedProcedureStatusService</a></li><li><a href="global.html#updateStartedTaskStatusService">updateStartedTaskStatusService</a></li><li><a href="global.html#updateTask">updateTask</a></li><li><a href="global.html#updateTaskService">updateTaskService</a></li><li><a href="global.html#updateWorker">updateWorker</a></li><li><a href="global.html#updateWorkerService">updateWorkerService</a></li><li><a href="global.html#uploadTask">uploadTask</a></li><li><a href="global.html#uploadTaskService">uploadTaskService</a></li><li><a href="global.html#validateSchema">validateSchema</a></li><li><a href="global.html#verifyRole">verifyRole</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Sun May 04 2025 21:04:32 GMT+0100 (hora de verano de Europa occidental)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
