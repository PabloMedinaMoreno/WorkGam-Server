<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/notification.service.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/notification.service.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { pool } from '../databases/db.js';

/**
 * Retrieves notifications for a given user.
 *
 * @param {number} personId - The ID of the user.
 * @returns {Promise&lt;Array>} A promise that resolves to an array of notifications.
 * @throws {Error} Throws an error if there is an issue querying the database.
 */
export const getNotificationsService = async (personId) => {
  try {
    const result = await pool.query(
      'SELECT * FROM notification WHERE person_id = $1 ORDER BY created_at DESC',
      [personId],
    );
    return result.rows;
  } catch (error) {
    console.error('Error al obtener las notificaciones en el servicio:', error);
    throw new Error(error.message || 'Error al obtener las notificaciones');
  }
};

/**
 * Marks a specific notification as read.
 *
 * @param {number} notificationId - The ID of the notification to update.
 * @returns {Promise&lt;Object>} A promise that resolves to the updated notification.
 * @throws {Error} Throws an error if the notification is not found or if there is an issue updating it.
 */
export const markNotificationAsReadService = async (notificationId) => {
  try {
    const result = await pool.query(
      'UPDATE notification SET is_read = TRUE WHERE id = $1 RETURNING *',
      [notificationId],
    );
    if (result.rowCount === 0) {
      throw new Error('Notificación no encontrada');
    }
    return result.rows[0];
  } catch (error) {
    console.error(
      'Error al marcar la notificación como leída en el servicio:',
      error,
    );
    throw new Error(
      error.message || 'Error al marcar la notificación como leída',
    );
  }
};

/**
 * Marks all notifications for a given user as read.
 *
 * @param {number} personId - The ID of the user.
 * @returns {Promise&lt;Array>} A promise that resolves to an array of updated notifications.
 * @throws {Error} Throws an error if there is an issue updating the notifications.
 */
export const markAllNotificationsAsReadService = async (personId) => {
  try {
    const result = await pool.query(
      'UPDATE notification SET is_read = TRUE WHERE person_id = $1 RETURNING *',
      [personId],
    );
    return result.rows;
  } catch (error) {
    console.error(
      'Error al marcar todas las notificaciones como leídas en el servicio:',
      error,
    );
    throw new Error(error.message || 'Error al marcar todas las notificaciones como leídas');
  }
};

/**
 * Creates a notification and optionally sends it in real-time using Socket.io.
 * @param {*} personId - The ID of the person receiving the notification.
 * @param {*} message - The message to be sent in the notification.
 * @param {*} io - Socket.io instance for real-time notifications (optional).
 * @param {*} socketId - Socket ID for sending notifications (optional).
 * @returns {Promise&lt;Object>} The created notification.
 */
export const createAndSendNotificationService = async (
  personId,
  message,
  io = null,
  socketId = null,
) => {
  const result = await pool.query(
    'INSERT INTO notification (person_id, message) VALUES ($1, $2) RETURNING *',
    [personId, message],
  );
  const notification = result.rows[0];

  // If io and socketId are provided, send the notification in real-time
  await sendWebSocketNotificationService(
    'new_notification',
    notification,
    io,
    socketId,
  );

  return notification;
};

/**
 * Sends a level-up notification to an employee and creates a notification in the database.
 * @param {*} employeeId - The ID of the employee.
 * @param {*} currentLevel - The current level of the employee.
 * @param {*} nextLevel - The new level of the employee.
 * @param {*} io - Socket.io instance for real-time notifications.
 * @param {*} socketId - Socket ID for sending notifications.
 */
export const sendLevelUpNotificationService = async (
  employeeId,
  currentLevel,
  nextLevel,
  io,
  socketId,
) => {
  // We send a level up event to the employee
  const levelData = {
    previousLevel: {
      name: currentLevel.name,
      xp: currentLevel.pointsRequired,
      image: currentLevel.image,
    },
    nextLevel: {
      name: nextLevel.name,
      xp: nextLevel.pointsRequired,
      image: nextLevel.image,
    },
  };
  // We create a notification for the employee
  await createAndSendNotificationService(
    employeeId,
    `¡Felicidades! Has subido de nivel a ${nextLevel.name}(${nextLevel.pointsRequired} XP)`,
    io,
    socketId,
  );
  // We send the level up event to the employee
  await sendWebSocketNotificationService(
    'level_up_notification',
    levelData,
    io,
    socketId,
  );
};



/**
 * Sends a WebSocket notification to a specific socket ID.
 * @param {*} notificationType - The type of notification to send.
 * @param {*} notificationData - The data to be sent with the notification.
 * @param {*} io - Socket.io instance for real-time notifications.
 * @param {*} socketId - Socket ID for sending notifications.
 */
export const sendWebSocketNotificationService = async (notificationType, notificationData, io, socketId) => {
  if (io &amp;&amp; socketId) {
    io.to(socketId).emit(notificationType, notificationData);
  }
};


/**
 * Deletes a notification by its ID.
 * @param {*} notificationId - The ID of the notification to delete.
 * @returns {Promise&lt;void>} A promise that resolves when the notification is deleted.
 * @throws {Error} Throws an error if there is an issue deleting the notification.
 */
export const deleteNotificationService = async (notificationId) => {
  try {
    const result = await pool.query(
      'DELETE FROM notification WHERE id = $1 RETURNING *',
      [notificationId],
    );
    if (result.rowCount === 0) {
      throw new Error('Notificación no encontrada');
    }
  } catch (error) {
    console.error('Error al eliminar la notificación en el servicio:', error);
    throw new Error(error.message || 'Error al eliminar la notificación');
  }

  // If the notification was deleted successfully, return a success message
  return { message: 'Notificación eliminada correctamente' };
};

/**
 * Deletes all notifications for a given user.
 * @param {*} personId - The ID of the user.
 * @returns {Promise&lt;void>} A promise that resolves when all notifications are deleted.
 * @throws {Error} Throws an error if there is an issue deleting the notifications.
 */
export const deleteAllNotificationsService = async (personId) => {
  try {
    const result = await pool.query(
      'DELETE FROM notification WHERE person_id = $1 RETURNING *',
      [personId],
    );
    if (result.rowCount === 0) {
      throw new Error('No se encontraron notificaciones para eliminar');
    }
  } catch (error) {
    console.error(
      'Error al eliminar todas las notificaciones en el servicio:',
      error,
    );
    throw new Error(error.message || 'Error al eliminar todas las notificaciones');
  }
  return { message: 'Todas las notificaciones eliminadas correctamente' };
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#acceptTask">acceptTask</a></li><li><a href="global.html#acceptTaskService">acceptTaskService</a></li><li><a href="global.html#authRequired">authRequired</a></li><li><a href="global.html#calculateXPGamification">calculateXPGamification</a></li><li><a href="global.html#cancelStartedProcedure">cancelStartedProcedure</a></li><li><a href="global.html#cancelStartedProcedureService">cancelStartedProcedureService</a></li><li><a href="global.html#changePassword">changePassword</a></li><li><a href="global.html#changePasswordService">changePasswordService</a></li><li><a href="global.html#checkBucketAccess">checkBucketAccess</a></li><li><a href="global.html#checkDBConnection">checkDBConnection</a></li><li><a href="global.html#checkS3Connection">checkS3Connection</a></li><li><a href="global.html#createAccessToken">createAccessToken</a></li><li><a href="global.html#createAndSendNotificationService">createAndSendNotificationService</a></li><li><a href="global.html#createProcedure">createProcedure</a></li><li><a href="global.html#createProcedureService">createProcedureService</a></li><li><a href="global.html#createProcedureTask">createProcedureTask</a></li><li><a href="global.html#createProcedureTaskService">createProcedureTaskService</a></li><li><a href="global.html#createRole">createRole</a></li><li><a href="global.html#createRoleService">createRoleService</a></li><li><a href="global.html#createWorker">createWorker</a></li><li><a href="global.html#createWorkerService">createWorkerService</a></li><li><a href="global.html#deleteAllNotifications">deleteAllNotifications</a></li><li><a href="global.html#deleteAllNotificationsService">deleteAllNotificationsService</a></li><li><a href="global.html#deleteNotification">deleteNotification</a></li><li><a href="global.html#deleteNotificationService">deleteNotificationService</a></li><li><a href="global.html#deleteProcedure">deleteProcedure</a></li><li><a href="global.html#deleteProcedureService">deleteProcedureService</a></li><li><a href="global.html#deleteRole">deleteRole</a></li><li><a href="global.html#deleteRoleService">deleteRoleService</a></li><li><a href="global.html#deleteTask">deleteTask</a></li><li><a href="global.html#deleteTaskService">deleteTaskService</a></li><li><a href="global.html#deleteWorker">deleteWorker</a></li><li><a href="global.html#deleteWorkerService">deleteWorkerService</a></li><li><a href="global.html#forgotPassword">forgotPassword</a></li><li><a href="global.html#forgotPasswordService">forgotPasswordService</a></li><li><a href="global.html#getClientPendingTasksService">getClientPendingTasksService</a></li><li><a href="global.html#getClientStartedTasksService">getClientStartedTasksService</a></li><li><a href="global.html#getCompletedTasks">getCompletedTasks</a></li><li><a href="global.html#getCompletedTasksService">getCompletedTasksService</a></li><li><a href="global.html#getEmployeeRolesService">getEmployeeRolesService</a></li><li><a href="global.html#getEmployeeStatistics">getEmployeeStatistics</a></li><li><a href="global.html#getEmployeeStatisticsService">getEmployeeStatisticsService</a></li><li><a href="global.html#getGamificationLevels">getGamificationLevels</a></li><li><a href="global.html#getGamificationLevelsService">getGamificationLevelsService</a></li><li><a href="global.html#getLevelProgression">getLevelProgression</a></li><li><a href="global.html#getLevelProgressionService">getLevelProgressionService</a></li><li><a href="global.html#getMyStartedProcedures">getMyStartedProcedures</a></li><li><a href="global.html#getMyStartedProceduresService">getMyStartedProceduresService</a></li><li><a href="global.html#getNotifications">getNotifications</a></li><li><a href="global.html#getNotificationsService">getNotificationsService</a></li><li><a href="global.html#getPendingTaskService">getPendingTaskService</a></li><li><a href="global.html#getPendingTasks">getPendingTasks</a></li><li><a href="global.html#getProcedureTasks">getProcedureTasks</a></li><li><a href="global.html#getProcedureTasksService">getProcedureTasksService</a></li><li><a href="global.html#getProcedures">getProcedures</a></li><li><a href="global.html#getProceduresService">getProceduresService</a></li><li><a href="global.html#getRanking">getRanking</a></li><li><a href="global.html#getRankingService">getRankingService</a></li><li><a href="global.html#getRoles">getRoles</a></li><li><a href="global.html#getRolesService">getRolesService</a></li><li><a href="global.html#getStartedProcedureTasks">getStartedProcedureTasks</a></li><li><a href="global.html#getStartedProcedureTasksService">getStartedProcedureTasksService</a></li><li><a href="global.html#getStartedProcedures">getStartedProcedures</a></li><li><a href="global.html#getStartedProceduresService">getStartedProceduresService</a></li><li><a href="global.html#getStartedTaskByStatusService">getStartedTaskByStatusService</a></li><li><a href="global.html#getStartedTaskService">getStartedTaskService</a></li><li><a href="global.html#getTaskService">getTaskService</a></li><li><a href="global.html#getTasks">getTasks</a></li><li><a href="global.html#getTasksService">getTasksService</a></li><li><a href="global.html#getUserLevelService">getUserLevelService</a></li><li><a href="global.html#getWorkers">getWorkers</a></li><li><a href="global.html#getWorkersService">getWorkersService</a></li><li><a href="global.html#handleXPAndNotificationService">handleXPAndNotificationService</a></li><li><a href="global.html#initializeDatabase">initializeDatabase</a></li><li><a href="global.html#insertDatabaseData">insertDatabaseData</a></li><li><a href="global.html#loadTemplate">loadTemplate</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#loginService">loginService</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#markAllNotificationsAsRead">markAllNotificationsAsRead</a></li><li><a href="global.html#markAllNotificationsAsReadService">markAllNotificationsAsReadService</a></li><li><a href="global.html#markNotificationAsRead">markNotificationAsRead</a></li><li><a href="global.html#markNotificationAsReadService">markNotificationAsReadService</a></li><li><a href="global.html#profile">profile</a></li><li><a href="global.html#profileService">profileService</a></li><li><a href="global.html#rejectTask">rejectTask</a></li><li><a href="global.html#rejectTaskService">rejectTaskService</a></li><li><a href="global.html#resetPassword">resetPassword</a></li><li><a href="global.html#resetPasswordService">resetPasswordService</a></li><li><a href="global.html#selectEmployeeByRoleService">selectEmployeeByRoleService</a></li><li><a href="global.html#sendEmail">sendEmail</a></li><li><a href="global.html#sendLevelUpNotificationService">sendLevelUpNotificationService</a></li><li><a href="global.html#sendWebSocketNotificationService">sendWebSocketNotificationService</a></li><li><a href="global.html#setupDatabaseSchema">setupDatabaseSchema</a></li><li><a href="global.html#signup">signup</a></li><li><a href="global.html#signupService">signupService</a></li><li><a href="global.html#startProcedure">startProcedure</a></li><li><a href="global.html#startProcedureService">startProcedureService</a></li><li><a href="global.html#updateEmployeeXPService">updateEmployeeXPService</a></li><li><a href="global.html#updateProcedure">updateProcedure</a></li><li><a href="global.html#updateProcedureService">updateProcedureService</a></li><li><a href="global.html#updateProfile">updateProfile</a></li><li><a href="global.html#updateProfilePic">updateProfilePic</a></li><li><a href="global.html#updateProfilePicService">updateProfilePicService</a></li><li><a href="global.html#updateProfileService">updateProfileService</a></li><li><a href="global.html#updateRole">updateRole</a></li><li><a href="global.html#updateRoleService">updateRoleService</a></li><li><a href="global.html#updateStartedProcedureStatusService">updateStartedProcedureStatusService</a></li><li><a href="global.html#updateStartedTaskStatusService">updateStartedTaskStatusService</a></li><li><a href="global.html#updateTask">updateTask</a></li><li><a href="global.html#updateTaskService">updateTaskService</a></li><li><a href="global.html#updateWorker">updateWorker</a></li><li><a href="global.html#updateWorkerService">updateWorkerService</a></li><li><a href="global.html#uploadTask">uploadTask</a></li><li><a href="global.html#uploadTaskService">uploadTaskService</a></li><li><a href="global.html#validateSchema">validateSchema</a></li><li><a href="global.html#verifyRole">verifyRole</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Sun May 04 2025 21:04:32 GMT+0100 (hora de verano de Europa occidental)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
