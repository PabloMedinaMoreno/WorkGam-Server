<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/procedure.service.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/procedure.service.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { pool } from '../databases/db.js';

/**
 * Retrieves all procedures.
 */
export const getProceduresService = async () => {
  try {
    const procedures = await pool.query('SELECT * FROM procedure');
    return procedures.rows;
  } catch (error) {
    console.error('Error al obtener los procedimientos:', error);
    throw new Error('Error al obtener los procedimientos');
  }
};

/**
 * Retrieves the tasks for a specific procedure.
 */
export const getProcedureTasksService = async (procedureId) => {
  try {
    const procedure = await pool.query('SELECT * FROM procedure WHERE id = $1', [procedureId]);
    if (procedure.rowCount === 0) {throw new Error('Procedimiento no encontrado');}

    const tasks = await pool.query('SELECT * FROM task WHERE procedure_id = $1', [procedureId]);
    return { procedure: procedure.rows[0], tasks: tasks.rows };
  } catch (error) {
    console.error('Error al obtener las tareas del procedimiento:', error);
    throw new Error(error.message);
  }
};

/**
 * Creates a new procedure.
 */
export const createProcedureService = async ({ name, description }) => {
  try {
    const check = await pool.query('SELECT * FROM procedure WHERE name = $1', [name]);
    if (check.rowCount > 0) {throw new Error('Ya existe un procedimiento con este nombre');}

    const result = await pool.query(
      'INSERT INTO procedure (name, description) VALUES ($1, $2) RETURNING *',
      [name, description],
    );
    return result.rows[0];
  } catch (error) {
    console.error('Error al crear el procedimiento:', error);
    throw new Error(error.message);
  }
};

/**
 * Updates a procedure by ID.
 */
export const updateProcedureService = async (procedureId, { name, description }) => {
  try {
    const exists = await pool.query('SELECT * FROM procedure WHERE id = $1', [procedureId]);
    if (exists.rowCount === 0) {throw new Error('Procedimiento no encontrado');}

    const duplicate = await pool.query(
      'SELECT * FROM procedure WHERE name = $1 AND id != $2',
      [name, procedureId],
    );
    if (duplicate.rowCount > 0) {throw new Error('Ya existe un procedimiento con este nombre');}

    const result = await pool.query(
      'UPDATE procedure SET name = $1, description = $2 WHERE id = $3 RETURNING *',
      [name, description, procedureId],
    );
    return result.rows[0];
  } catch (error) {
    console.error('Error al actualizar el procedimiento:', error);
    throw new Error(error.message);
  }
};

/**
 * Deletes a procedure by ID.
 */
export const deleteProcedureService = async (procedureId) => {
  try {
    const check = await pool.query('SELECT * FROM procedure WHERE id = $1', [procedureId]);
    if (check.rowCount === 0) {throw new Error('Procedimiento no encontrado');}

    await pool.query('DELETE FROM procedure WHERE id = $1', [procedureId]);
  } catch (error) {
    console.error('Error al eliminar el procedimiento:', error);
    throw new Error(error.message);
  }
};

/**
 * Starts a procedure for a client.
 */
export const startProcedureService = async (procedureId, clientId) => {
  try {
    const client = await pool.query('SELECT * FROM client WHERE id = $1', [clientId]);
    if (client.rowCount === 0) {throw new Error('Cliente no encontrado');}

    const procedure = await pool.query('SELECT * FROM procedure WHERE id = $1', [procedureId]);
    if (procedure.rowCount === 0) {throw new Error('Procedimiento no encontrado');}

    const alreadyStarted = await pool.query(
      'SELECT * FROM started_procedure WHERE procedure_id = $1 AND client_id = $2',
      [procedureId, clientId],
    );
    if (alreadyStarted.rowCount > 0) {throw new Error('Ya ha iniciado este procedimiento');}

    const started = await pool.query(
      "INSERT INTO started_procedure (procedure_id, client_id, status) VALUES ($1, $2, 'pending') RETURNING *",
      [procedureId, clientId],
    );

    return {
      startedProcedure: started.rows[0],
      procedureName: procedure.rows[0].name,
    };
  } catch (error) {
    console.error('Error al iniciar el procedimiento:', error);
    throw new Error(error.message);
  }
};

/**
 * Cancels a started procedure.
 */
export const cancelStartedProcedureService = async (startedProcedureId, clientId) => {
  try {
    const started = await pool.query(
      'SELECT * FROM started_procedure WHERE id = $1 AND client_id = $2',
      [startedProcedureId, clientId],
    );
    if (started.rowCount === 0) {throw new Error('Procedimiento no encontrado');}

    await pool.query('DELETE FROM started_procedure WHERE id = $1', [startedProcedureId]);

    const procedure = await pool.query(
      'SELECT * FROM procedure WHERE id = $1',
      [started.rows[0].procedure_id],
    );

    return { procedureName: procedure.rows[0].name };
  } catch (error) {
    console.error('Error al cancelar el procedimiento:', error);
    throw new Error(error.message);
  }
};

/**
 * Retrieves all procedures started by a client.
 */
export const getMyStartedProceduresService = async (clientId) => {
  try {
    const result = await pool.query(
      `SELECT i.id, i.procedure_id, i.client_id, i.status, i.start_date, i.end_date, 
              p.name, p.description 
       FROM started_procedure i 
       JOIN procedure p ON i.procedure_id = p.id 
       WHERE client_id = $1`,
      [clientId],
    );
    return result.rows;
  } catch (error) {
    console.error('Error al obtener procedimientos iniciados:', error);
    throw new Error('Error al obtener procedimientos iniciados');
  }
};

/**
 * Creates a task for a specific procedure.
 */
export const createProcedureTaskService = async (
  procedureId,
  { name, description, xp, role_id, estimated_duration_days, difficulty },
) => {
  try {
    const procedure = await pool.query('SELECT * FROM procedure WHERE id = $1', [procedureId]);
    if (procedure.rowCount === 0) {throw new Error('Procedimiento no encontrado');}

    const task = await pool.query(
      `INSERT INTO task 
        (name, description, xp, procedure_id, role_id, estimated_duration_days, difficulty) 
       VALUES ($1, $2, $3, $4, $5, $6, $7) 
       RETURNING *`,
      [name, description, xp, procedureId, role_id, estimated_duration_days, difficulty],
    );
    return task.rows[0];
  } catch (error) {
    console.error('Error al crear la tarea del procedimiento:', error);
    throw new Error(error.message);
  }
};

/**
 * Retrieves all procedures started by all clients.
 */
export const getStartedProceduresService = async () => {
  try {
    const result = await pool.query(`
      SELECT 
        ip.id AS started_procedure_id,
        p.name AS procedure_name,
        per.username AS client_username,
        ip.status,
        ip.start_date,
        ip.end_date
      FROM started_procedure ip
      JOIN procedure p ON ip.procedure_id = p.id
      JOIN person per ON ip.client_id = per.id
      ORDER BY ip.start_date DESC
    `);
    return result.rows;
  } catch (error) {
    console.error('Error al obtener procedimientos iniciados:', error);
    throw new Error('Error al obtener procedimientos iniciados');
  }
};

/**
 * Retrieves tasks for a specific started procedure.
 */
export const getStartedProcedureTasksService = async (startedProcedureId) => {
  try {
    const started = await pool.query('SELECT * FROM started_procedure WHERE id = $1', [
      startedProcedureId,
    ]);
    if (started.rowCount === 0) {throw new Error('Procedimiento iniciado no encontrado');}

    const result = await pool.query(
      `SELECT 
        it.id AS started_task_id,
        t.name AS task_name,
        t.description AS task_description,
        it.status,
        it.start_date,
        it.end_date,
        e.username AS employee_username,
        it.document_uploaded
       FROM started_task it
       JOIN task t ON it.task_id = t.id
       JOIN person e ON it.employee_id = e.id
       WHERE it.started_procedure_id = $1
       ORDER BY it.start_date ASC`,
      [startedProcedureId],
    );

    return result.rows;
  } catch (error) {
    console.error('Error al obtener tareas del procedimiento iniciado:', error);
    throw new Error(error.message);
  }
};

/**
 * Updates the status of a started procedure.
 * @param {*} startedProcedureId - ID of the started procedure to update
 * @param {*} param1 - Object containing the new status
 * @param {*} param1.status - New status for the started procedure
 * @returns {Promise&lt;Object>} - Updated started procedure
 * @throws {Error} - Throws an error if the started procedure is not found or if an error occurs during the update
 */
export const updateStartedProcedureStatusService = async (startedProcedureId, status) => {
  try {
    const started = await pool.query(
      'SELECT * FROM started_procedure WHERE id = $1',
      [startedProcedureId],
    );
    if (started.rowCount === 0) {throw new Error('Procedimiento iniciado no encontrado');}

    const result = await pool.query(
      'UPDATE started_procedure SET status = $1 WHERE id = $2 RETURNING *',
      [status, startedProcedureId],
    );

    console.log('Procedimiento iniciado actualizado:', result.rows[0]);

    return result.rows[0];
  } catch (error) {
    console.error('Error al actualizar el procedimiento iniciado:', error);
    throw new Error(error.message);
  }
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#acceptTask">acceptTask</a></li><li><a href="global.html#acceptTaskService">acceptTaskService</a></li><li><a href="global.html#authRequired">authRequired</a></li><li><a href="global.html#calculateXPGamification">calculateXPGamification</a></li><li><a href="global.html#cancelStartedProcedure">cancelStartedProcedure</a></li><li><a href="global.html#cancelStartedProcedureService">cancelStartedProcedureService</a></li><li><a href="global.html#changePassword">changePassword</a></li><li><a href="global.html#changePasswordService">changePasswordService</a></li><li><a href="global.html#checkBucketAccess">checkBucketAccess</a></li><li><a href="global.html#checkDBConnection">checkDBConnection</a></li><li><a href="global.html#checkS3Connection">checkS3Connection</a></li><li><a href="global.html#createAccessToken">createAccessToken</a></li><li><a href="global.html#createAndSendNotificationService">createAndSendNotificationService</a></li><li><a href="global.html#createProcedure">createProcedure</a></li><li><a href="global.html#createProcedureService">createProcedureService</a></li><li><a href="global.html#createProcedureTask">createProcedureTask</a></li><li><a href="global.html#createProcedureTaskService">createProcedureTaskService</a></li><li><a href="global.html#createRole">createRole</a></li><li><a href="global.html#createRoleService">createRoleService</a></li><li><a href="global.html#createWorker">createWorker</a></li><li><a href="global.html#createWorkerService">createWorkerService</a></li><li><a href="global.html#deleteAllNotifications">deleteAllNotifications</a></li><li><a href="global.html#deleteAllNotificationsService">deleteAllNotificationsService</a></li><li><a href="global.html#deleteNotification">deleteNotification</a></li><li><a href="global.html#deleteNotificationService">deleteNotificationService</a></li><li><a href="global.html#deleteProcedure">deleteProcedure</a></li><li><a href="global.html#deleteProcedureService">deleteProcedureService</a></li><li><a href="global.html#deleteRole">deleteRole</a></li><li><a href="global.html#deleteRoleService">deleteRoleService</a></li><li><a href="global.html#deleteTask">deleteTask</a></li><li><a href="global.html#deleteTaskService">deleteTaskService</a></li><li><a href="global.html#deleteWorker">deleteWorker</a></li><li><a href="global.html#deleteWorkerService">deleteWorkerService</a></li><li><a href="global.html#forgotPassword">forgotPassword</a></li><li><a href="global.html#forgotPasswordService">forgotPasswordService</a></li><li><a href="global.html#getCompletedTasks">getCompletedTasks</a></li><li><a href="global.html#getCompletedTasksService">getCompletedTasksService</a></li><li><a href="global.html#getEmployeeRolesService">getEmployeeRolesService</a></li><li><a href="global.html#getEmployeeStatistics">getEmployeeStatistics</a></li><li><a href="global.html#getEmployeeStatisticsService">getEmployeeStatisticsService</a></li><li><a href="global.html#getGamificationLevels">getGamificationLevels</a></li><li><a href="global.html#getGamificationLevelsService">getGamificationLevelsService</a></li><li><a href="global.html#getLevelProgression">getLevelProgression</a></li><li><a href="global.html#getLevelProgressionService">getLevelProgressionService</a></li><li><a href="global.html#getMyStartedProcedures">getMyStartedProcedures</a></li><li><a href="global.html#getMyStartedProceduresService">getMyStartedProceduresService</a></li><li><a href="global.html#getNotifications">getNotifications</a></li><li><a href="global.html#getNotificationsService">getNotificationsService</a></li><li><a href="global.html#getPendingTaskService">getPendingTaskService</a></li><li><a href="global.html#getPendingTasks">getPendingTasks</a></li><li><a href="global.html#getProcedureTasks">getProcedureTasks</a></li><li><a href="global.html#getProcedureTasksService">getProcedureTasksService</a></li><li><a href="global.html#getProcedures">getProcedures</a></li><li><a href="global.html#getProceduresService">getProceduresService</a></li><li><a href="global.html#getRanking">getRanking</a></li><li><a href="global.html#getRankingService">getRankingService</a></li><li><a href="global.html#getRoles">getRoles</a></li><li><a href="global.html#getRolesService">getRolesService</a></li><li><a href="global.html#getStartedProcedureTasks">getStartedProcedureTasks</a></li><li><a href="global.html#getStartedProcedureTasksService">getStartedProcedureTasksService</a></li><li><a href="global.html#getStartedProcedures">getStartedProcedures</a></li><li><a href="global.html#getStartedProceduresService">getStartedProceduresService</a></li><li><a href="global.html#getStartedTaskByStatusService">getStartedTaskByStatusService</a></li><li><a href="global.html#getStartedTaskService">getStartedTaskService</a></li><li><a href="global.html#getTaskService">getTaskService</a></li><li><a href="global.html#getTasks">getTasks</a></li><li><a href="global.html#getTasksService">getTasksService</a></li><li><a href="global.html#getUserLevelService">getUserLevelService</a></li><li><a href="global.html#getWorkers">getWorkers</a></li><li><a href="global.html#getWorkersService">getWorkersService</a></li><li><a href="global.html#handleXPAndNotificationService">handleXPAndNotificationService</a></li><li><a href="global.html#initializeDatabase">initializeDatabase</a></li><li><a href="global.html#insertDatabaseData">insertDatabaseData</a></li><li><a href="global.html#loadTemplate">loadTemplate</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#loginService">loginService</a></li><li><a href="global.html#logout">logout</a></li><li><a href="global.html#logoutService">logoutService</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#markAllNotificationsAsRead">markAllNotificationsAsRead</a></li><li><a href="global.html#markAllNotificationsAsReadService">markAllNotificationsAsReadService</a></li><li><a href="global.html#markNotificationAsRead">markNotificationAsRead</a></li><li><a href="global.html#markNotificationAsReadService">markNotificationAsReadService</a></li><li><a href="global.html#profile">profile</a></li><li><a href="global.html#profileService">profileService</a></li><li><a href="global.html#rejectTask">rejectTask</a></li><li><a href="global.html#rejectTaskService">rejectTaskService</a></li><li><a href="global.html#resetPassword">resetPassword</a></li><li><a href="global.html#resetPasswordService">resetPasswordService</a></li><li><a href="global.html#selectEmployeeByRoleService">selectEmployeeByRoleService</a></li><li><a href="global.html#sendEmail">sendEmail</a></li><li><a href="global.html#sendLevelUpNotificationService">sendLevelUpNotificationService</a></li><li><a href="global.html#sendWebSocketNotificationService">sendWebSocketNotificationService</a></li><li><a href="global.html#setupDatabaseSchema">setupDatabaseSchema</a></li><li><a href="global.html#signup">signup</a></li><li><a href="global.html#signupService">signupService</a></li><li><a href="global.html#startProcedure">startProcedure</a></li><li><a href="global.html#startProcedureService">startProcedureService</a></li><li><a href="global.html#updateEmployeeXPService">updateEmployeeXPService</a></li><li><a href="global.html#updateProcedure">updateProcedure</a></li><li><a href="global.html#updateProcedureService">updateProcedureService</a></li><li><a href="global.html#updateProfile">updateProfile</a></li><li><a href="global.html#updateProfilePic">updateProfilePic</a></li><li><a href="global.html#updateProfilePicService">updateProfilePicService</a></li><li><a href="global.html#updateProfileService">updateProfileService</a></li><li><a href="global.html#updateRole">updateRole</a></li><li><a href="global.html#updateRoleService">updateRoleService</a></li><li><a href="global.html#updateStartedProcedureStatusService">updateStartedProcedureStatusService</a></li><li><a href="global.html#updateStartedTaskStatusService">updateStartedTaskStatusService</a></li><li><a href="global.html#updateTask">updateTask</a></li><li><a href="global.html#updateTaskService">updateTaskService</a></li><li><a href="global.html#updateWorker">updateWorker</a></li><li><a href="global.html#updateWorkerService">updateWorkerService</a></li><li><a href="global.html#uploadTask">uploadTask</a></li><li><a href="global.html#uploadTaskService">uploadTaskService</a></li><li><a href="global.html#validateSchema">validateSchema</a></li><li><a href="global.html#verifyRole">verifyRole</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Thu Apr 24 2025 18:36:05 GMT+0100 (hora de verano de Europa occidental)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
