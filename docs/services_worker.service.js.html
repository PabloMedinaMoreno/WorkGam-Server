<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/worker.service.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/worker.service.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { pool } from '../databases/db.js';
import { createAndSendNotificationService } from './notification.service.js';
import bcrypt from 'bcryptjs';

/**
 * Creates a new worker in the system.
 * @param {Object} workerData - The data for the worker to be created.
 * @returns {Promise&lt;Object>} The created worker's data.
 */
export const createWorkerService = async ({
  username,
  email,
  password,
  gender,
  phone,
  role_id,
}) => {
  // Encrypt the password
  const hashedPassword = await bcrypt.hash(password, 10);

  // Define the profile picture based on gender
  const profilePic =
    gender === 'male'
      ? `https://avatar.iran.liara.run/public/boy?username=${username}`
      : `https://avatar.iran.liara.run/public/girl?username=${username}`;

  try {
    // Check if the email already exists
    const emailCheck = await pool.query(
      'SELECT * FROM person WHERE email = $1',
      [email],
    );
    if (emailCheck.rowCount > 0) {
      throw new Error('El email ya está registrado');
    }

    // Insert the worker in the person table
    const personResult = await pool.query(
      'INSERT INTO person (username, email, password, profile_pic, phone) VALUES ($1, $2, $3, $4, $5) RETURNING *',
      [username, email, hashedPassword, profilePic, phone || null],
    );
    const personId = personResult.rows[0].id;

    // Insert the worker in the employee table
    await pool.query(
      'INSERT INTO employee (id, role_id) VALUES ($1, $2) RETURNING *',
      [personId, role_id],
    );

    // Insert the worker in the gamification table
    await pool.query('INSERT INTO gamification (employee_id) VALUES ($1)', [
      personId,
    ]);

    // Create a welcome notification
    await createAndSendNotificationService(
      personId,
      '¡Bienvenido a la plataforma!',
    );

    return {
      id: personId,
      username,
      email,
      role: role_id, // Assuming role_id is passed
      profile_pic: profilePic,
      phone,
    };
  } catch (error) {
    console.error('Error registering worker:', error);
    throw new Error(error.message || 'Error registrando el trabajador');
  }
};

/**
 * Retrieves all workers from the system.
 * @returns {Promise&lt;Array>} An array of all workers.
 */
export const getWorkersService = async () => {
  try {
    const result = await pool.query(
      `SELECT p.id, p.username, p.email, p.profile_pic, p.phone, r.name AS role
       FROM person p JOIN employee e ON p.id = e.id JOIN role r ON e.role_id = r.id`,
    );
    return result.rows;
  } catch (error) {
    console.error('Error getting workers:', error);
    throw new Error('Error getting workers');
  }
};

/**
 * Updates a worker's information in the system.
 * @param {number} workerId - The worker's ID to update.
 * @param {Object} workerData - The data to update.
 * @returns {Promise&lt;Object>} The updated worker's data.
 */
export const updateWorkerService = async (
  workerId,
  { username, email, role_id, phone },
) => {
  try {

    const existingWorker = await pool.query(
      'SELECT * FROM person WHERE id = $1',
      [workerId],
    );

    // Check if the worker exists
    if (existingWorker.rowCount === 0) {
      throw new Error('El trabajador no existe');
    }
    // Check if the email already exists for another worker
    const emailCheck = await pool.query(
      'SELECT * FROM person WHERE email = $1 AND id != $2',
      [email, workerId],
    );

    if (emailCheck.rowCount > 0) {
      throw new Error('El email ya está registrado');
    }
    // Check if the role exists
    const roleCheck = await pool.query(
      'SELECT * FROM role WHERE id = $1',
      [role_id],
    );
    if (roleCheck.rowCount === 0) {
      throw new Error('El rol no existe');
    }

    // Update the worker's personal information
    const updatedPerson = await pool.query(
      'UPDATE person SET username = $1, email = $2, phone = $3 WHERE id = $4 RETURNING *',
      [username, email, phone || null, workerId],
    );

    // Update the worker's role
    await pool.query('UPDATE employee SET role_id = $1 WHERE id = $2', [
      role_id,
      workerId,
    ]);

    // Get the updated worker's information with the role
    const role = await pool.query('SELECT name FROM role WHERE id = $1', [
      role_id,
    ]);

    return {
      id: workerId,
      username: updatedPerson.rows[0].username,
      email: updatedPerson.rows[0].email,
      role: role.rows[0].name,
      profile_pic: updatedPerson.rows[0].profile_pic,
      phone: updatedPerson.rows[0].phone || 'N/A',
    };
  } catch (error) {
    console.error('Error updating worker:', error);
    throw new Error(error.message || 'Error updating worker');
  }
};

/**
 * Deletes a worker from the system.
 * @param {number} workerId - The worker's ID to delete.
 * @returns {Promise&lt;void>} Resolves with no return value when the worker is deleted.
 */
export const deleteWorkerService = async (workerId) => {
  try {
    // Check if the worker exists
    const existingWorker = await pool.query(
      'SELECT * FROM person WHERE id = $1',
      [workerId],
    );
    if (existingWorker.rowCount === 0) {
      throw new Error('El trabajador no existe');
    }

    // Delete the worker from the gamification table
    await pool.query('DELETE FROM gamification WHERE employee_id = $1', [
      workerId,
    ]);
    // Delete the worker from the employee table
    await pool.query('DELETE FROM employee WHERE id = $1', [workerId]);

    // Delete the worker from the person table
    await pool.query('DELETE FROM person WHERE id = $1', [workerId]);
  } catch (error) {
    console.error('Error deleting worker:', error);
    throw new Error(error.message || 'Error deleting worker');
  }
};

/**
 * This function selects an employee by role
 * @param {Number} role_id - ID of the employee's role
 * @returns {Number} employee_id - ID of the selected employee
 */
export const selectEmployeeByRoleService = async (role_id) => {
  try {
    // We get the employee with the least experience
    const employee = await pool.query(
      'SELECT * FROM gamification G JOIN employee E ON G.employee_id = E.id WHERE E.role_id = $1 ORDER BY G.xp_total ASC LIMIT 1',
      [role_id],
    );
    // If there are no rows we throw an error
    if (employee.rowCount === 0) {
      throw new Error('No hay empleados con ese rol.');
    }
    const employee_id = employee.rows[0].employee_id;
    return employee_id;
  } catch (error) {
    console.error('Error obteniendo empleados por experiencia:', error);
    throw new Error(error.message);
  }
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#acceptTask">acceptTask</a></li><li><a href="global.html#acceptTaskService">acceptTaskService</a></li><li><a href="global.html#authRequired">authRequired</a></li><li><a href="global.html#calculateXPGamification">calculateXPGamification</a></li><li><a href="global.html#cancelStartedProcedure">cancelStartedProcedure</a></li><li><a href="global.html#cancelStartedProcedureService">cancelStartedProcedureService</a></li><li><a href="global.html#changePassword">changePassword</a></li><li><a href="global.html#changePasswordService">changePasswordService</a></li><li><a href="global.html#checkBucketAccess">checkBucketAccess</a></li><li><a href="global.html#checkDBConnection">checkDBConnection</a></li><li><a href="global.html#checkS3Connection">checkS3Connection</a></li><li><a href="global.html#createAccessToken">createAccessToken</a></li><li><a href="global.html#createAndSendNotificationService">createAndSendNotificationService</a></li><li><a href="global.html#createProcedure">createProcedure</a></li><li><a href="global.html#createProcedureService">createProcedureService</a></li><li><a href="global.html#createProcedureTask">createProcedureTask</a></li><li><a href="global.html#createProcedureTaskService">createProcedureTaskService</a></li><li><a href="global.html#createRole">createRole</a></li><li><a href="global.html#createRoleService">createRoleService</a></li><li><a href="global.html#createWorker">createWorker</a></li><li><a href="global.html#createWorkerService">createWorkerService</a></li><li><a href="global.html#deleteAllNotifications">deleteAllNotifications</a></li><li><a href="global.html#deleteAllNotificationsService">deleteAllNotificationsService</a></li><li><a href="global.html#deleteNotification">deleteNotification</a></li><li><a href="global.html#deleteNotificationService">deleteNotificationService</a></li><li><a href="global.html#deleteProcedure">deleteProcedure</a></li><li><a href="global.html#deleteProcedureService">deleteProcedureService</a></li><li><a href="global.html#deleteRole">deleteRole</a></li><li><a href="global.html#deleteRoleService">deleteRoleService</a></li><li><a href="global.html#deleteTask">deleteTask</a></li><li><a href="global.html#deleteTaskService">deleteTaskService</a></li><li><a href="global.html#deleteWorker">deleteWorker</a></li><li><a href="global.html#deleteWorkerService">deleteWorkerService</a></li><li><a href="global.html#forgotPassword">forgotPassword</a></li><li><a href="global.html#forgotPasswordService">forgotPasswordService</a></li><li><a href="global.html#getCompletedTasks">getCompletedTasks</a></li><li><a href="global.html#getCompletedTasksService">getCompletedTasksService</a></li><li><a href="global.html#getEmployeeRolesService">getEmployeeRolesService</a></li><li><a href="global.html#getEmployeeStatistics">getEmployeeStatistics</a></li><li><a href="global.html#getEmployeeStatisticsService">getEmployeeStatisticsService</a></li><li><a href="global.html#getGamificationLevels">getGamificationLevels</a></li><li><a href="global.html#getGamificationLevelsService">getGamificationLevelsService</a></li><li><a href="global.html#getLevelProgression">getLevelProgression</a></li><li><a href="global.html#getLevelProgressionService">getLevelProgressionService</a></li><li><a href="global.html#getMyStartedProcedures">getMyStartedProcedures</a></li><li><a href="global.html#getMyStartedProceduresService">getMyStartedProceduresService</a></li><li><a href="global.html#getNotifications">getNotifications</a></li><li><a href="global.html#getNotificationsService">getNotificationsService</a></li><li><a href="global.html#getPendingTaskService">getPendingTaskService</a></li><li><a href="global.html#getPendingTasks">getPendingTasks</a></li><li><a href="global.html#getProcedureTasks">getProcedureTasks</a></li><li><a href="global.html#getProcedureTasksService">getProcedureTasksService</a></li><li><a href="global.html#getProcedures">getProcedures</a></li><li><a href="global.html#getProceduresService">getProceduresService</a></li><li><a href="global.html#getRanking">getRanking</a></li><li><a href="global.html#getRankingService">getRankingService</a></li><li><a href="global.html#getRoles">getRoles</a></li><li><a href="global.html#getRolesService">getRolesService</a></li><li><a href="global.html#getStartedProcedureTasks">getStartedProcedureTasks</a></li><li><a href="global.html#getStartedProcedureTasksService">getStartedProcedureTasksService</a></li><li><a href="global.html#getStartedProcedures">getStartedProcedures</a></li><li><a href="global.html#getStartedProceduresService">getStartedProceduresService</a></li><li><a href="global.html#getStartedTaskByStatusService">getStartedTaskByStatusService</a></li><li><a href="global.html#getStartedTaskService">getStartedTaskService</a></li><li><a href="global.html#getTaskService">getTaskService</a></li><li><a href="global.html#getTasks">getTasks</a></li><li><a href="global.html#getTasksService">getTasksService</a></li><li><a href="global.html#getUserLevelService">getUserLevelService</a></li><li><a href="global.html#getWorkers">getWorkers</a></li><li><a href="global.html#getWorkersService">getWorkersService</a></li><li><a href="global.html#handleXPAndNotificationService">handleXPAndNotificationService</a></li><li><a href="global.html#initializeDatabase">initializeDatabase</a></li><li><a href="global.html#insertDatabaseData">insertDatabaseData</a></li><li><a href="global.html#loadTemplate">loadTemplate</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#loginService">loginService</a></li><li><a href="global.html#logout">logout</a></li><li><a href="global.html#logoutService">logoutService</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#markAllNotificationsAsRead">markAllNotificationsAsRead</a></li><li><a href="global.html#markAllNotificationsAsReadService">markAllNotificationsAsReadService</a></li><li><a href="global.html#markNotificationAsRead">markNotificationAsRead</a></li><li><a href="global.html#markNotificationAsReadService">markNotificationAsReadService</a></li><li><a href="global.html#profile">profile</a></li><li><a href="global.html#profileService">profileService</a></li><li><a href="global.html#rejectTask">rejectTask</a></li><li><a href="global.html#rejectTaskService">rejectTaskService</a></li><li><a href="global.html#resetPassword">resetPassword</a></li><li><a href="global.html#resetPasswordService">resetPasswordService</a></li><li><a href="global.html#selectEmployeeByRoleService">selectEmployeeByRoleService</a></li><li><a href="global.html#sendEmail">sendEmail</a></li><li><a href="global.html#sendLevelUpNotificationService">sendLevelUpNotificationService</a></li><li><a href="global.html#sendWebSocketNotificationService">sendWebSocketNotificationService</a></li><li><a href="global.html#setupDatabaseSchema">setupDatabaseSchema</a></li><li><a href="global.html#signup">signup</a></li><li><a href="global.html#signupService">signupService</a></li><li><a href="global.html#startProcedure">startProcedure</a></li><li><a href="global.html#startProcedureService">startProcedureService</a></li><li><a href="global.html#updateEmployeeXPService">updateEmployeeXPService</a></li><li><a href="global.html#updateProcedure">updateProcedure</a></li><li><a href="global.html#updateProcedureService">updateProcedureService</a></li><li><a href="global.html#updateProfile">updateProfile</a></li><li><a href="global.html#updateProfilePic">updateProfilePic</a></li><li><a href="global.html#updateProfilePicService">updateProfilePicService</a></li><li><a href="global.html#updateProfileService">updateProfileService</a></li><li><a href="global.html#updateRole">updateRole</a></li><li><a href="global.html#updateRoleService">updateRoleService</a></li><li><a href="global.html#updateStartedProcedureStatusService">updateStartedProcedureStatusService</a></li><li><a href="global.html#updateStartedTaskStatusService">updateStartedTaskStatusService</a></li><li><a href="global.html#updateTask">updateTask</a></li><li><a href="global.html#updateTaskService">updateTaskService</a></li><li><a href="global.html#updateWorker">updateWorker</a></li><li><a href="global.html#updateWorkerService">updateWorkerService</a></li><li><a href="global.html#uploadTask">uploadTask</a></li><li><a href="global.html#uploadTaskService">uploadTaskService</a></li><li><a href="global.html#validateSchema">validateSchema</a></li><li><a href="global.html#verifyRole">verifyRole</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Thu Apr 24 2025 18:36:05 GMT+0100 (hora de verano de Europa occidental)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
